# Email System Testing Instructions

## Overview
This document explains how to test the email reply system, which allows experts to reply to article requests via email. The system uses SendGrid for email delivery and processing.

## Key Files
- `scripts/test-email.ts` - Script to send test emails
- `src/lib/email.ts` - Core email functionality
- `api/inbound.ts` - Webhook handler for email replies
- `.env` - Environment variables configuration

## Prerequisites
1. Make sure you have the following environment variables set in `.env`:
   ```
   SENDGRID_API_KEY=your_sendgrid_key
   SENDGRID_DOMAIN=prometheus.ninja
   VITE_SUPABASE_URL=your_supabase_url
   VITE_SUPABASE_ANON_KEY=your_supabase_key
   ```

2. Ensure all dependencies are installed:
   ```bash
   npm install
   ```

## Sending Test Emails

### Method 1: Using the Test Script
1. Run the test script using tsx:
   ```bash
   tsx scripts/test-email.ts
   ```
2. The script will send a test email to sean.w.meehan@gmail.com
3. You'll receive a success message with a token like:
   ```
   Result: { success: true, token: 'xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx' }
   ```

### Testing the Reply Flow
1. After receiving the test email, reply to it
2. Your reply will be processed by the webhook at `api/inbound.ts`
3. The system will:
   - Extract the token from the reply-to address
   - Validate the token
   - Process the email content
   - Store the reply as a comment

## Monitoring
- Check Vercel logs for webhook processing
- Check Supabase for stored comments
- Monitor SendGrid dashboard for email delivery status

## Troubleshooting
1. If the test script fails:
   - Verify environment variables are set correctly
   - Check SendGrid API key permissions
   - Ensure the domain is verified in SendGrid

2. If replies aren't being processed:
   - Check Vercel logs for webhook errors
   - Verify SendGrid inbound parse webhook configuration
   - Ensure the token format in the reply-to address is correct

## Notes
- Test emails are sent to sean.w.meehan@gmail.com by default
- Tokens expire after 7 days
- Each token can only be used once
- The system supports both plain text and HTML email replies
